 Comandos de Sincronizaci贸n, Clustering y Alta Disponibilidad
1. Sincronizaci贸n de Archivos (RSYNC)
Bash

# ===============================================
# 1. RSYNC (Sincronizaci贸n de Archivos)
# ===============================================

# Crear directorios para la prueba
mkdir origen
mkdir destino

# Crear 100 archivos en el directorio destino
touch /destino/SO{1..100}

# Sincronizaci贸n simple (copia todo lo que cambi贸)
rsync -a destino/ origen

# Eliminar contenido de origen (para demostrar la copia)
rm origen/* -r 

# Simular la sincronizaci贸n (-n: Dry Run, -v: Verbose, -a: Archivo)
rsync -anv destino/ origen  

# Crear un archivo nuevo para verificar la detecci贸n de cambios
touch destino/SO101
rsync -av destino/ origen  # Ahora s铆 copia el nuevo archivo

# Excluir un archivo espec铆fico
rsync -av --exclude=SO1 destino/ origen

# Excluir archivos usando una lista de un archivo de texto
# (Asumiendo que /tmp/exposicion/archivocreado contiene los nombres de archivos a excluir)
rsync -av --exclude-from=/tmp/exposicion/archivocreado destino/ origen

# --- RSYNC con SSH (Transferencia Remota) ---

# Enviar (PUSH) del cliente al servidor:
rsync -av destino/ miguel@direcionip:/home/miguel/Desktop 

# Recibir (PULL) del servidor al cliente:
# (Asumiendo que 'miguel.txt' y 'matricula.txt' est谩n en /tmp/archivos/ en el servidor)
rysnc -av usuario@ip:/tmp/archivo /tmp/exposicion

# --- Opciones Adicionales de RSYNC ---

# Comprimir el archivo (-z: ayuda a consumir menos ancho de banda)
rysnc -z ...

# Mostrar el progreso (-P)
rysnc -P ...

# Especificar puerto SSH diferente (-e "ssh -p XXXX")
rsync -avzP -e "ssh -p 2222" origen/ usuario@ip:/ruta/destino
2. Configuraci贸n de Cluster (Pacemaker y Corosync)
Bash

# ===============================================
# 2. CLUSTER (Pacemaker/Corosync)
# ===============================================

# --- 1. Instalaci贸n de Paquetes (Ambas m谩quinas) ---
sudo apt update
sudo apt install -y pacemaker corosync pcs fence-agents resource-agents

# --- 2. Configuraci贸n de Firewall (Ambas m谩quinas) ---
# Puertos requeridos por Corosync (5404, 5405) y PCSD (2224, 9929)
sudo ufw allow 5404/udp
sudo ufw allow 5405/udp
sudo ufw allow 2224/tcp
sudo ufw allow 9929/tcp
sudo ufw reload

# --- 3. Habilitaci贸n de Servicios (Ambas m谩quinas) ---
sudo systemctl enable --now pcsd
sudo systemctl enable corosync
sudo systemctl enable pacemaker

# --- 4. Configuraci贸n del Cluster (Solo en nodo principal) ---
# Autenticar nodos (usando usuario hacluster, IPs de ejemplo)
sudo pcs host auth 192.168.6.115 192.168.0.120 -u hacluster
# Crear el cluster
sudo pcs cluster setup mycluster 192.168.6.115 192.168.0.120
# Iniciar y habilitar el cluster
sudo pcs cluster start --all
sudo pcs cluster enable --all

# --- 5. Iniciar Servicios (Ambas m谩quinas) ---
sudo systemctl start corosync
sudo systemctl start pacemaker

# --- 6. Verificar Estado y STONITH ---
sudo pcs status
# Deshabilitar STONITH (si aparece el warning, no recomendado en producci贸n)
sudo pcs property set stonith-enabled=false

# --- 7. Crear Recurso de IP Flotante ---
sudo pcs resource create clusterIP ocf:heartbeat:IPaddr2 ip=192.168.0.161 cidr_netmask=24 op monitor interval=30s

# --- 8. Verificaci贸n Final ---
sudo pcs status
sudo pcs resource show
sudo pcs cluster status

# --- 9. Borrar Configuraci贸n (Ambas m谩quinas) ---
# DESTRUIR CLUSTERS EXISTENTES
sudo pcs cluster destroy
sudo systemctl stop pacemaker corosync
sudo systemctl disable pacemaker corosync
# Limpiar configuraciones antiguas
sudo rm -rf /etc/corosync/corosync.conf
sudo rm -rf /var/lib/pacemaker/cib/
sudo rm -rf /var/lib/cluster/
# REINICIAR PCSD (antes de configurar un cluster nuevo)
sudo systemctl stop pcsd
sudo systemctl start pcsd
# Configurar Cluster Nuevo con --force (para reescritura)
sudo pcs cluster setup mycluster 192.168.100.57 192.168.100.110 --force
# INICIAR CLUSTER NUEVO
sudo pcs cluster start --all
sudo pcs cluster enable --all
3. Configuraci贸n de Alta Disponibilidad (Keepalived)
Bash

# ===============================================
# 3. ALTA DISPONIBILIDAD (Keepalived)
# ===============================================

# (ASUMIMOS HOSTS VIRTUALES CON NOMBRES so1 y so2 CREADOS EN APACHE O NGINX)

# Instalaci贸n de Keepalived (Ambas m谩quinas)
sudo apt install keepalived

# Habilitar e iniciar el servicio (Ambas m谩quinas)
sudo systemctl enable keepalived
sudo systemctl start keepalived
# Verificar estado: sudo systemctl status keepalived

# Navegar al directorio de configuraci贸n
cd /etc/keepalived

# Modificar el archivo de configuraci贸n (Ambas m谩quinas)
sudo nano keepalived.conf

# CONFIGURACIN CLAVE DENTRO DE keepalived.conf:
# Nota: La IP flotante de ejemplo es 192.168.100.200

# # CONFIGURACIN PARA SERVIDOR MASTER
# state MASTER
# interface en33               # Adaptador de red (ej: en33)
# virtual_router_id 51
# priority 100                 # Privilegio m谩s alto para MASTER
# virtual_ipaddress {
#     192.168.100.200/24       # IP flotante (VIP)
# }

# # CONFIGURACIN PARA SERVIDOR BACKUP
# state BACKUP
# interface en33               # Adaptador de red (ej: en33)
# virtual_router_id 51
# priority 50                  # Privilegio m谩s bajo para BACKUP
# virtual_ipaddress {
#     192.168.100.200/24
# }

# Recargar/Reiniciar el servicio (Ambas m谩quinas)
sudo systemctl reload keepalived
sudo systemctl restart keepalived

# Verificar la configuraci贸n usando la IP flotante
# (Acceder desde navegador a http://192.168.100.200)
4. Configuraci贸n de Balanceo de Carga (HAProxy)
Bash

# ===============================================
# 4. BALANCEO DE CARGA (HAProxy)
# ===============================================

# 1. Instalar HAProxy
sudo apt install -y haproxy

# 2. Configurar Puertos (Ejemplo de Apache en el puerto 8080)
# Esto implica que los servidores backend (Apache) deben estar escuchando en 8080.
# sudo nano /etc/apache2/ports.conf # (Asegurarse de que escuche en 8080)

# 3. Configurar HAProxy
cd /etc/haproxy 
sudo nano haproxy.cfg

# Contenido clave de haproxy.cfg (Ejemplo similar a la Imagen image_1b9777.png):
# frontend http_front
#     bind *:80                    # Escuchar en el puerto 80 (p煤blico)
#     default_backend http_back    # Enviar tr谩fico al backend definido

# backend http_back
#     balance roundrobin           # Algoritmo de balanceo
#     server host_1 10.0.1.11:80   # Servidor 1 (IP interna o local)
#     server host_2 10.0.1.12:80   # Servidor 2
#     server host_3 10.0.1.13:80   # Servidor 3

# 4. Reiniciar el servicio
sudo systemctl reload haproxy
sudo systemctl restart haproxy
